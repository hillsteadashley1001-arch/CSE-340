<%-
/*
  Expected locals from controller:
  - title
  - nav (HTML)
  - classificationList (HTML from utilities.buildClassificationList)
  - inv_make, inv_model, inv_year, inv_description, inv_image, inv_thumbnail,
    inv_price, inv_miles, inv_color (sticky values)
  - errors: either a mapped object (errors.field.msg) or a Result with .array()
  - flash notices via messages() helper or locals.notice
*/
-%>

<% if (title) { %>
  <h1><%= title %></h1>
<% } %>

<% // Flash (express-messages helper) %>
<% const _msg = typeof messages === 'function' ? messages() : '' %>
<% if (_msg && _msg.trim().length) { %>
  <%- _msg %>
<% } %>
<% // Single notice string placed in locals %>
<% if (locals.notice && String(locals.notice).trim().length) { %>
  <div class="notice"><%= locals.notice %></div>
<% } %>
<% // Server-side errors (supports .array() and mapped object) %>
<%
  const hasErrors =
    errors &&
    (
      (typeof errors.array === 'function' && errors.array().length > 0) ||
      (typeof errors.array !== 'function' && Object.keys(errors).length > 0)
    )
%>
<% if (hasErrors) { %>
  <ul class="message warning" role="alert" aria-live="polite">
    <% if (typeof errors.array === 'function') { %>
      <% errors.array().forEach(err => { %><li><%= err.msg %></li><% }) %>
    <% } else { %>
      <% Object.values(errors).forEach(err => { %><li><%= err.msg %></li><% }) %>
    <% } %>
  </ul>
<% } %>

<div id="formContainer">
  <p>All fields are required.</p>

  <form action="/inv/add-inventory" method="post" class="formspread" novalidate>
    <!-- Classification -->
    <label for="classificationList">Classification</label>
    <%- classificationList %>
    <% if (errors && errors.classification_id) { %>
      <p class="error"><%= errors.classification_id.msg %></p>
    <% } %>

    <!-- Make -->
    <label for="invMake">Make</label>
    <input
      type="text"
      name="inv_make"
      id="invMake"
      required
      minlength="2"
      value="<%= inv_make || '' %>"
    />
    <% if (errors && errors.inv_make) { %>
      <p class="error"><%= errors.inv_make.msg %></p>
    <% } %>

    <!-- Model -->
    <label for="invModel">Model</label>
    <input
      type="text"
      name="inv_model"
      id="invModel"
      required
      minlength="1"
      value="<%= inv_model || '' %>"
    />
    <% if (errors && errors.inv_model) { %>
      <p class="error"><%= errors.inv_model.msg %></p>
    <% } %>

    <!-- Description -->
    <label for="invDescription">Description</label>
    <textarea
      name="inv_description"
      id="invDescription"
      required
      rows="4"
    ><%= inv_description || '' %></textarea>
    <% if (errors && errors.inv_description) { %>
      <p class="error"><%= errors.inv_description.msg %></p>
    <% } %>

    <!-- Image Path -->
    <label for="invImage">Image Path</label>
    <input
      type="text"
      name="inv_image"
      id="invImage"
      size="30"
      required
      value="<%= inv_image || '/images/vehicles/no-image.png' %>"
      pattern="^[A-Za-z0-9_\/.\-]+$"
      title="Path may include letters, numbers, / . _ -"
    />
    <% if (errors && errors.inv_image) { %>
      <p class="error"><%= errors.inv_image.msg %></p>
    <% } %>

    <!-- Thumbnail Path -->
    <label for="invThumbnail">Thumbnail Path</label>
    <input
      type="text"
      name="inv_thumbnail"
      id="invThumbnail"
      size="30"
      required
      value="<%= inv_thumbnail || '/images/vehicles/no-image-tn.png' %>"
      pattern="^[A-Za-z0-9_\/.\-]+$"
      title="Path may include letters, numbers, / . _ -"
    />
    <% if (errors && errors.inv_thumbnail) { %>
      <p class="error"><%= errors.inv_thumbnail.msg %></p>
    <% } %>

    <!-- Price -->
    <label for="invPrice">Price</label>
    <input
      type="number"
      name="inv_price"
      id="invPrice"
      step="0.01"
      min="0"
      required
      value="<%= typeof inv_price !== 'undefined' ? inv_price : '' %>"
    />
    <% if (errors && errors.inv_price) { %>
      <p class="error"><%= errors.inv_price.msg %></p>
    <% } %>

    <!-- Year -->
    <label for="invYear">Year</label>
    <input
      type="number"
      name="inv_year"
      id="invYear"
      min="1900"
      max="2100"
      required
      value="<%= typeof inv_year !== 'undefined' ? inv_year : '' %>"
    />
    <% if (errors && errors.inv_year) { %>
      <p class="error"><%= errors.inv_year.msg %></p>
    <% } %>

    <!-- Miles -->
    <label for="invMiles">Miles</label>
    <input
      type="number"
      name="inv_miles"
      id="invMiles"
      min="0"
      required
      value="<%= typeof inv_miles !== 'undefined' ? inv_miles : '' %>"
    />
    <% if (errors && errors.inv_miles) { %>
      <p class="error"><%= errors.inv_miles.msg %></p>
    <% } %>

    <!-- Color -->
    <label for="invColor">Color</label>
    <input
      type="text"
      name="inv_color"
      id="invColor"
      required
      value="<%= inv_color || '' %>"
    />
    <% if (errors && errors.inv_color) { %>
      <p class="error"><%= errors.inv_color.msg %></p>
    <% } %>

    <button type="submit">Add Vehicle</button>
  </form>
</div>